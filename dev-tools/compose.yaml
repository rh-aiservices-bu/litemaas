# This configuration exposes services on your host machine's network
# PostgreSQL for LiteLLM: localhost:5432
# PostgreSQL for LiteMaaS: localhost:5433
# LiteLLM: http://localhost:4000

services:
  # PostgreSQL Database for LiteLLM
  postgres:
    image: postgres:16-alpine
    container_name: litellm-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_LITTELLM_USER:-litellm_user}
      POSTGRES_PASSWORD: ${POSTGRES_LITTELLM_PASSWORD:-litellm_password}
      POSTGRES_DB: ${POSTGRES_LITTELLM_DB:-litellm_db}
      PGDATA: /var/lib/postgresql/data/pgdata
      # Allow connections from any host (development only!)
      POSTGRES_HOST_AUTH_METHOD: "scram-sha-256"
    ports:
      - "5432:5432"  # PostgreSQL accessible at localhost:5432
    userns_mode: keep-id
    volumes:
      - ./data/postgres-litellm:/var/lib/postgresql/data:Z
    networks:
      - litellm-network
    # Make PostgreSQL listen on all interfaces (not just localhost)
    command: postgres -c listen_addresses='*'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_LITTELLM_USER:-litellm_user} -d ${POSTGRES_LITTELLM_DB:-litellm_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # LiteLLM Service
  litellm:
    image: ghcr.io/berriai/litellm:main-stable
    container_name: litellm-service
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database configuration
      DATABASE_URL: "postgresql://${POSTGRES_USER:-litellm_user}:${POSTGRES_PASSWORD:-litellm_password}@postgres:5432/${POSTGRES_DB:-litellm_db}"
      
      # LiteLLM configuration
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-1234}
      UI_USERNAME: ${UI_USERNAME:-admin}
      UI_PASSWORD: ${UI_PASSWORD:-admin}
    
      # Other configurations
      LITELLM_MODE: "PRODUCTION"
      STORE_MODEL_IN_DB: "True"
    ports:
      - "4000:4000"  # LiteLLM UI accessible at http://localhost:4000
    userns_mode: keep-id
    volumes:
      - ./data/litellm:/app/data:Z
      - ./litellm-config.yaml:/app/config.yaml:ro  # Optional: mount config file
    networks:
      - litellm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: [ "--config", "/app/config.yaml", "--detailed_debug" ]

  # PostgreSQL Database for LiteMaaS
  postgres-litemaas:
    image: postgres:16-alpine
    container_name: litemaas-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_LITEMAAS_USER:-litemaas_user}
      POSTGRES_PASSWORD: ${POSTGRES_LITEMAAS_PASSWORD:-litemaas_password}
      POSTGRES_DB: ${POSTGRES_LITEMAAS_DB:-litemaas_db}
      PGDATA: /var/lib/postgresql/data/pgdata
      # Allow connections from any host (development only!)
      POSTGRES_HOST_AUTH_METHOD: "scram-sha-256"
    ports:
      - "5433:5432"  # FIXED: Map host 5433 to container 5432 (where PostgreSQL actually listens)
    userns_mode: keep-id  # This can stay!
    volumes:
      - ./data/postgres-litemaas:/var/lib/postgresql/data:Z
    networks:
      - litellm-network
    # Make PostgreSQL listen on all interfaces (not just localhost)
    command: postgres -c listen_addresses='*'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_LITEMAAS_USER:-litemaas_user} -d ${POSTGRES_LITEMAAS_DB:-litemaas_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  litellm-network:
    driver: bridge
    name: litellm-network